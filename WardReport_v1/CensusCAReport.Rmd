# Draft Census Ward Report for `r community`
##### Report Date: `r Sys.Date()`

```{r setup, include=FALSE}
#this code section is  all the R code we want to run to prepare objects for the report itself. All processing, reformatting, library loading, etc. should be done in this r chunk. Actually creating the maps and tables and any text should be done in later code sections. 

suppressWarnings(suppressPackageStartupMessages(library(tmap)))
suppressWarnings(suppressPackageStartupMessages(library(sp)))
suppressWarnings(suppressPackageStartupMessages(library(sf)))
library(knitr)
library(markdown)
library(rmarkdown)

#Create the ward-specific overlap files to be used in the making the map and table
CA_tract_overlap1 <- gWithin(spgeom1 = shp_tracts, 
                         spgeom2 = shp_community[shp_community@data$community == community, ],
                         byid = TRUE) 
CA_tract_overlap2 <- gOverlaps(spgeom1 = shp_tracts, 
                         spgeom2 = shp_community[shp_community@data$community == community, ],
                         byid = TRUE)
CA_tract_overlap <- Reduce("|", list(CA_tract_overlap1, CA_tract_overlap2))
rm(CA_tract_overlap1, CA_tract_overlap2)

CA_spdf <- shp_tracts[which(CA_tract_overlap), ]
dt <- data.table(shp_tracts@data[which(CA_tract_overlap), ])
rm(CA_tract_overlap)

#convert file to tmap format
CA_sf <- st_as_sf(CA_spdf, crs = 4326)

#make the map
popups <- c("NAMELSAD", "low_response_score", "tot_population_cen_2010", "tot_housing_units_cen_2010", "nh_blk_alone_acs_13_17", "hispanic_acs_13_17", "eng_vw_acs_13_17", "HH_SingleParent")
breaks <- seq(0, 45, by = 5)

map1 <- tm_shape(CA_sf, is.master = TRUE) + 
  tm_polygons(col = "low_response_score", palette = "YlOrRd", style="cont", alpha = .7, title = "Low       Response Score", breaks=breaks, popup.var = popups, group = "Relevant Community Area Census Tracts") +
  tm_layout(title = "Heatmap of Low Response Scores") +
  tm_view(view.legend.position = c("left", "bottom"))  +
  tm_basemap(server = "OpenMapSurfer.Roads") +
  tm_shape(shp_community[shp_community@data$community == community, ]) +
  tm_borders(col = "blue", lwd=3, group = paste0(community, " Outline"))

dt2<- dt[, .(low_response_score, tot_population_cen_2010, nh_blk_alone_acs_13_17, 
             hispanic_acs_13_17, tot_housing_units_cen_2010, eng_vw_acs_13_17,
             HH_SingleParent), by = "NAMELSAD"]
dt2<- na.omit(dt2)

dt2[, c("perc_LEP", "perc_SP"):=list((eng_vw_acs_13_17/tot_housing_units_cen_2010*100), 
                                     (HH_SingleParent/tot_housing_units_cen_2010*100)), ]

YlOrRd <- function(x) rgb(colorRamp(c("#fff7ba", "#fee28a", "#fec05b", "#fd923e", "#fc502a", "#df171c", "#b00026"))(x), maxColorValue = 255)

table <- reactable(dt2, columns = list (
    NAMELSAD = colDef(name = "Census Tract"),
    low_response_score = colDef(name = "Low Response Score", defaultSortOrder = "desc",
                                style = function(value) {
        if (!is.numeric(value)) return(min(shp_tracts@data$low_response_score, na.rm=TRUE))
        normalized <- (value - min(shp_tracts@data$low_response_score, na.rm=TRUE)) / (max(shp_tracts@data$low_response_score, na.rm=TRUE) - min(shp_tracts@data$low_response_score, na.rm=TRUE))
        color <- YlOrRd(normalized)
        list(background = color)
    }),
    tot_population_cen_2010 = colDef(name = "Total"),
    nh_blk_alone_acs_13_17 = colDef(name = "Black"), 
    hispanic_acs_13_17 = colDef(name = "Hispanic"),
    tot_housing_units_cen_2010 = colDef(name = "Total"),
    eng_vw_acs_13_17 = colDef(name = "Limited English Proficiency (LEP)"),
    perc_LEP = colDef(name = "% LEP", format = colFormat(digits = 2)),
    HH_SingleParent = colDef(name = "Single Parent"),
    perc_SP = colDef(name = "% Single Parent", format = colFormat(digits = 2))
), 
columnGroups = list(
    colGroup(name = "Population", columns = c("tot_population_cen_2010", "nh_blk_alone_acs_13_17",
             "hispanic_acs_13_17")),
    colGroup(name = "Households", columns = c("tot_housing_units_cen_2010", "eng_vw_acs_13_17", 
                                              "perc_LEP", "HH_SingleParent", "perc_SP"))
), bordered = TRUE, resizable = TRUE, defaultSorted = "low_response_score")
```

## Response Rate Map

```{r map, echo = FALSE}
map1
```


## Data Table

```{r datatable, echo = FALSE}
table
```